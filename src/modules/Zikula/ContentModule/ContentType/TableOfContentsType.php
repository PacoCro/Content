<?php
/**
 * Content.
 *
 * @copyright Axel Guckelsberger (Zikula)
 * @license http://www.gnu.org/licenses/lgpl.html GNU Lesser General Public License
 * @author Axel Guckelsberger <vorstand@zikula.de>.
 * @link https://zikula.de
 * @link http://zikula.org
 * @version Generated by ModuleStudio 1.3.2 (https://modulestudio.de).
 */

namespace Zikula\ContentModule\ContentType;

use Zikula\ContentModule\AbstractContentType;
use Zikula\ContentModule\ContentTypeInterface;
use Zikula\ContentModule\ContentType\Form\Type\TableOfContentsType as FormType;

/**
 * Table of contents content type.
 */
class TableOfContentsType extends AbstractContentType
{
    /**
     * @inheritDoc
     */
    public function getCategory()
    {
        return ContentTypeInterface::CATEGORY_BASIC;
    }

    /**
     * @inheritDoc
     */
    public function getIcon()
    {
        return 'book';
    }

    /**
     * @inheritDoc
     */
    public function getTitle()
    {
        return $this->__('Table of contents');
    }

    /**
     * @inheritDoc
     */
    public function getDescription()
    {
        return $this->__('A table of contents of headings and subpages (built from the available Content pages).');
    }

    /**
     * @inheritDoc
     */
    public function getDefaultData()
    {
        return [
            'pageId' => 0/* TODO $this->pageId */,
            'includeSelf' => false,
            'includeNotInMenu' => false,
            'includeHeading' => 0, 
            'includeHeadingLevel' => 0,
            'includeSubpage' => 1,
            'includeSubpageLevel' => 0
        ];
    }

/** TODO    
    public function display()
    {
        $tables = DBUtil::getTables();
        $pageColumn = $tables['content_page_column'];

        $options = array('makeTree' => true, 'expandContent' => false);
        $options['orderBy'] = 'setLeft';

        // get the current active page where this contentitem is in
        $curPage = ModUtil::apiFunc('Content', 'page', 'getPage', array('id' => $this->pageId, 'makeTree' => false, 'includeContent' => false));

        if ($this->pageId == 0 && $this->includeSubpage) {
            if ($this->includeSubpage == 2) {
                $options['filter']['where'] = "$pageColumn[level] <= ".($this->includeSubpageLevel-1);
            }
        } else {
            if ($this->includeSubpage) {
                if ($this->includeSubpage == 2 && $this->includeSubpageLevel > 0) {
                    $page = ModUtil::apiFunc('Content', 'page', 'getPage', array('id' => $this->pageId));
                    if ($page === false) {
                        return '';
                    }
                    $options['filter']['where'] = "$pageColumn[level] <= ".($page['level'] + $this->includeSubpageLevel);
                }
                $options['filter']['superParentId'] = $this->pageId;
            } else {
                // this is a special case, this is also applied if pageId==0 and no subpages included, which makes no sense
                $options['filter']['parentId'] = $this->pageId;
            }
        }
        if (!$this->includeNotInMenu) {
            $options['filter']['checkInMenu'] = true;
        }
        if ($this->includeHeadingLevel >= 0) {
            $options['includeContent'] = true;
        }
        $pages = ModUtil::apiFunc('Content', 'Page', 'getPages', $options);

        if ($this->pageId != 0 && !$this->includeSelf) {
            $toc = $this->_genTocRecursive($pages[0], 0);
        } else {
            $toc = array();
            foreach (array_keys($pages) as $page) {
                $toc['toc'][] = $this->_genTocRecursive($pages[$page], ($this->pageId == 0 ? 1 : 0));
            }
        }

        $this->view->assign('page', $curPage);
        $this->view->assign('toc', $toc);
        $this->view->assign('contentId', $this->contentId);
        return $this->view->fetch($this->getTemplate());
    }
    
    protected function _genTocRecursive(&$pages, $level)
    {
        $toc = array();
        $pageurl = ModUtil::url('Content', 'user', 'view', array('pageId' => $pages['id']));
        if ($pages['content'] && ($this->includeHeading == 1 || $this->includeHeadingLevel - $level >= 0)) {
            foreach (array_keys($pages['content']) as $area) {
                foreach (array_keys($pages['content'][$area]) as $id) {
                    $plugin = &$pages['content'][$area][$id];
                    if ($plugin['plugin'] != null && $plugin['plugin']->getModule() == 'Content' && $plugin['plugin']->getName() == 'Heading') {
                        $toc[] = array('title' => $plugin['plugin']->getText(), 'url' => $pageurl . "#heading_" . $plugin['id'], 'level' => $level, 'css' => 'content-toc-heading');
                    }
                }
            }
        }

        if ($pages['subPages']) {
            foreach (array_keys($pages['subPages']) as $id) {
                $toc[] = $this->_genTocRecursive($pages['subPages'][$id], $level + 1);
            }
        }

        return array('pageId' => $pages['id'], 'title' => $pages['title'], 'url' => $pageurl, 'level' => $level, 'css' => '', 'toc' => $toc);
    }
    
    public function displayEditing()
    {
        if ($this->pageId == 0) {
            $title = $this->__('All pages');
        } else {
            $page = ModUtil::apiFunc('Content', 'Page', 'getPage', array('id' => $this->pageId, 'includeContent' => false, 'translate' => false, 'filter' => array('checkActive' => false)));
            $title = $page['title'];
        }
        return "<h3>" . $this->__f('Table of contents of %s', htmlspecialchars($title)) . "</h3>";
    }
*/
    /**
     * @inheritDoc
     */
    public function getEditFormClass()
    {
        return FormType::class;
    }
}
