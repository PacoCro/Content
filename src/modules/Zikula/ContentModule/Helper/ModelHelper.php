<?php
/**
 * Content.
 *
 * @copyright Axel Guckelsberger (Zikula)
 * @license http://www.gnu.org/licenses/lgpl.html GNU Lesser General Public License
 * @author Axel Guckelsberger <info@ziku.la>.
 * @link https://ziku.la
 * @version Generated by ModuleStudio 1.3.2 (https://modulestudio.de).
 */

namespace Zikula\ContentModule\Helper;

use Zikula\ContentModule\Helper\Base\AbstractModelHelper;

/**
 * Helper implementation class for model layer methods.
 */
class ModelHelper extends AbstractModelHelper
{
    /**
     * @inheritDoc
     */
    public function resolveSortParameter($objectType = '', $sorting = 'default')
    {
        if ('page' == $objectType && 'views' == $sorting) {
            return 'views DESC';
        }

        return parent::resolveSortParameter($objectType, $sorting);
    }

    /**
     * Duplicates all translations of a given page.
     *
     * @param integer $oldPageId
     * @param integer $newPageId
     * @param string  $titleSuffix
     */
    public function clonePageTranslations($oldPageId, $newPageId, $titleSuffix)
    {
        $entityManager = $this->entityFactory->getObjectManager();
        $translationRepository = $entityManager->getRepository('Zikula\ContentModule\Entity\PageTranslationEntity');

        // first remove translations which were cloned above
        $translations = $translationRepository->findBy(['foreignKey' => $newPageId]);
        foreach ($translations as $translation) {
            $entityManager->remove($translation);
        }
        $entityManager->flush();

        // second clone all translations
        $translations = $translationRepository->findBy(['foreignKey' => $oldPageId]);
        $newTranslations = [];
        foreach ($translations as $translation) {
            $newTranslation = clone $translation;
            $newTranslation->setForeignKey($newPageId);
            if ('title' == $newTranslation->getField()) {
                $newTranslation->setContent($newTranslation->getContent() . $titleSuffix);
            } elseif ('slug' == $newTranslation->getField()) {
                $newTranslation->setContent($newTranslation->getContent() . str_replace(' ', '-', $titleSuffix));
            }
            $entityManager->persist($newTranslation);
        }
        $entityManager->flush();
    }

    /**
     * Duplicates all translations of a given content item.
     *
     * @param integer $oldItemId
     * @param integer $newItemId
     */
    public function cloneContentTranslations($oldItemId, $newItemId)
    {
        $entityManager = $this->entityFactory->getObjectManager();
        $translationRepository = $entityManager->getRepository('Zikula\ContentModule\Entity\ContentItemTranslationEntity');

        // first remove translations which were cloned above
        $translations = $translationRepository->findBy(['foreignKey' => $newItemId]);
        foreach ($translations as $translation) {
            $entityManager->remove($translation);
        }
        $entityManager->flush();

        // second clone all translations
        $translations = $translationRepository->findBy(['foreignKey' => $oldItemId]);
        $newTranslations = [];
        foreach ($translations as $translation) {
            $newTranslation = clone $translation;
            $newTranslation->setForeignKey($newItemId);
            $entityManager->persist($newTranslation);
        }
        $entityManager->flush();
    }
}
